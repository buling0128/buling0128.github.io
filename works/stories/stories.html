<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>布灵的创作空间 - 故事集</title>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
    <div class="container">
        <div class="works-container">
            <h2 class="works-title">故事集</h2>
            
            <div class="works-grid">
                <!-- 因赛美那 -->
                <div class="work-card">
                    <img src="../../images/card.jpg" alt="因赛美那" class="work-card-image">
                    <div class="work-card-content">
                        <h3 class="work-card-title">因赛美那</h3>
                        <p class="work-card-description">包含原初版、15版、23版、24版、neo版、25版等多个版本的故事内容。</p>
                        <button class="work-card-button" onclick="loadWork('insaimena')">查看详情</button>
                    </div>
                </div>
                <!-- 樱之都奈樱 -->
                <div class="work-card">
                    <img src="../../images/card.jpg" alt="樱之都奈樱" class="work-card-image">
                    <div class="work-card-content">
                        <h3 class="work-card-title">樱之都奈樱</h3>
                        <p class="work-card-description">包含散装版、旧版、24版、25版等多个版本的故事内容。</p>
                        <button class="work-card-button" onclick="loadWork('sakura')">查看详情</button>
                    </div>
                </div>
                <!-- 其他IP卡片（妖鬼街、提奈拉普等）保持不变 -->
                <div class="work-card">
                    <img src="../../images/card.jpg" alt="妖鬼街" class="work-card-image">
                    <div class="work-card-content">
                        <h3 class="work-card-title">妖鬼街</h3>
                        <p class="work-card-description">妖鬼街的故事集，探索这个神秘街道上发生的各种奇妙故事。</p>
                        <button class="work-card-button" onclick="loadWork('yaoguijie')">查看详情</button>
                    </div>
                </div>
                <!-- 此处省略其他IP卡片，保持与原代码一致 -->
            </div>
            
            <!-- 作品详情展示区域（结构不变） -->
            <div id="workDetail" class="work-detail-container" style="display: none;">
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                </div>
                <div id="workContent" style="display: none;">
                    <h2 class="work-detail-title" id="detailTitle"></h2>
                    <div class="work-detail-content">
                        <div class="work-detail-image">
                            <img id="detailImage" src="" alt="作品图片">
                        </div>
                        <div class="work-detail-info">
                            <div class="work-detail-description" id="detailDescription"></div>
                            <div class="work-detail-meta">
                                <div class="work-detail-meta-item">
                                    <span class="work-detail-meta-label">创作时间：</span>
                                    <span id="detailTime"></span>
                                </div>
                                <div class="work-detail-meta-item">
                                    <span class="work-detail-meta-label">类型：</span>
                                    <span id="detailType"></span>
                                </div>
                                <div class="work-detail-meta-item">
                                    <span class="work-detail-meta-label">状态：</span>
                                    <span id="detailStatus"></span>
                                </div>
                            </div>
                            <!-- 版本选择 -->
                            <div id="versionSelect" class="mt-4">
                                <h3 class="text-lg font-semibold mb-2">选择版本：</h3>
                                <div class="flex flex-wrap gap-2" id="versionButtons"></div>
                            </div>
                            <!-- 版本内容 -->
                            <div id="versionContent" class="mt-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-md font-semibold mb-2" id="versionTitle"></h4>
                                <div id="versionDescription"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="error" id="error" style="display: none;">
                    <p>加载作品详情失败，请稍后再试。</p>
                </div>
            </div>
        </div>
    </div>

    <script src="../../js/navbar.js"></script>
    <script>
        // 存储当前加载的IP基础信息（全局变量，供版本切换使用）
        let currentWorkInfo = null;

        /**
         * 加载IP基础信息（第一步：先加载IP的标题、类型等基础内容）
         * @param {string} workKey - IP文件夹名称（如insaimena、sakura）
         */
        function loadWork(workKey) {
            // 显示加载动画
            const workDetail = document.getElementById('workDetail');
            const loading = document.getElementById('loading');
            const workContent = document.getElementById('workContent');
            const error = document.getElementById('error');
            
            workDetail.style.display = 'block';
            loading.style.display = 'flex';
            workContent.style.display = 'none';
            error.style.display = 'none';

            // 1. 加载该IP的基础信息（info.json）
            fetch(`data/${workKey}/info.json`)
                .then(response => {
                    if (!response.ok) throw new Error('基础信息加载失败');
                    return response.json();
                })
                .then(workInfo => {
                    currentWorkInfo = workInfo; // 保存基础信息，供版本加载使用
                    
                    // 2. 更新IP基础信息到页面
                    document.getElementById('detailTitle').textContent = workInfo.title;
                    document.getElementById('detailImage').src = workInfo.image;
                    document.getElementById('detailImage').alt = workInfo.title;
                    document.getElementById('detailDescription').innerHTML = workInfo.description;
                    document.getElementById('detailTime').textContent = workInfo.time;
                    document.getElementById('detailType').textContent = workInfo.type;
                    document.getElementById('detailStatus').textContent = workInfo.status;

                    // 3. 生成版本选择按钮（并绑定加载版本的事件）
                    const versionButtons = document.getElementById('versionButtons');
                    versionButtons.innerHTML = ''; // 清空原有按钮
                    
                    workInfo.versions.forEach(versionName => {
                        const button = document.createElement('button');
                        button.className = 'px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition';
                        button.textContent = versionName;
                        // 点击按钮加载对应版本的故事内容
                        button.onclick = () => loadVersion(workKey, versionName);
                        versionButtons.appendChild(button);
                    });

                    // 4. 默认加载第一个版本的内容
                    if (workInfo.versions.length > 0) {
                        loadVersion(workKey, workInfo.versions[0]);
                    }

                    // 5. 显示基础信息，隐藏加载动画
                    loading.style.display = 'none';
                    workContent.style.display = 'block';
                    workDetail.scrollIntoView({ behavior: 'smooth' });
                })
                .catch(err => {
                    console.error('加载失败:', err);
                    loading.style.display = 'none';
                    error.style.display = 'block';
                });
        }

        /**
         * 加载指定IP的指定版本故事内容（第二步：加载版本详情）
         * @param {string} workKey - IP文件夹名称（如insaimena）
         * @param {string} versionName - 版本名称（如“原初版”）
         */
        function loadVersion(workKey, versionName) {
            const versionTitleEl = document.getElementById('versionTitle');
            const versionDescEl = document.getElementById('versionDescription');
            const versionButtons = document.querySelectorAll('#versionButtons button');

            // 1. 加载该版本的故事文件（如“原初版.json”）
            fetch(`data/${workKey}/${versionName}.json`)
                .then(response => {
                    if (!response.ok) throw new Error(`版本“${versionName}”加载失败`);
                    return response.json();
                })
                .then(versionData => {
                    // 2. 更新版本内容到页面
                    versionTitleEl.textContent = versionData.title;
                    versionDescEl.innerHTML = versionData.description;

                    // 3. 更新版本按钮样式（高亮当前选中的版本）
                    versionButtons.forEach(btn => {
                        if (btn.textContent === versionName) {
                            btn.classList.remove('bg-blue-500');
                            btn.classList.add('bg-blue-700');
                        } else {
                            btn.classList.remove('bg-blue-700');
                            btn.classList.add('bg-blue-500');
                        }
                    });
                })
                .catch(err => {
                    console.error('版本加载失败:', err);
                    versionTitleEl.textContent = '版本加载失败';
                    versionDescEl.innerHTML = '<p class="text-red-500">该版本的故事内容暂时无法加载，请稍后再试。</p>';
                });
        }
    </script>
</body>
</html>
